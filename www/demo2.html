<html>
    <head>
        <title>NPR API Plugin for JQuery </title>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script type="text/javascript" src="jquery.bus.js"></script>
    
        <script type="text/javascript">
        getUrlParameter = function( pname, pdefault ) {
            try {    
                // From this page:  http://www.netlobo.com/url_query_string_javascript.html
                pname = pname.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
                var regexS = "[\\?&]"+pname+"=([^&#]*)";
                var regex = new RegExp( regexS );
                var results = regex.exec( window.location.href );
                if( results === null ) {
                    return pdefault;
                }
                else {
                    return results[1];
                }
            } catch (e) {
                alert(e);
            }
        };
        
        $(document).ready(function() {
            
            var apiKeyFromUrl = getUrlParameter('apiKey', null);
           
            $(document).bus({"apiKey" : apiKeyFromUrl}).loadCurrentEpisodes({"callback" : function(data) {
            	
            	$.each(data, function(index, episode) {
            		episodeName = episode.program.name;
                    
                    var streamUrl = null;
                    $.each(episode.stream.audio, function(index, audioStream) {
                        if (audioStream.type == "Audio MP3 Stream") {
                            streamUrl = audioStream.url;
                            return false;
                        }
                            
                    });
                    
                    if (streamUrl) {
                        $.get("decodeStream.php?filename=" + streamUrl,null, function(mp3Url) {
                            
                            if (mp3Url != "ERROR") {
                                var aElm = document.createElement("audio");
                                var sElm = document.createElement("source");
                                sElm.src = mp3Url;
                                sElm.type = "audio/mp3";
                                $(aElm).html(sElm);
                                aElm.controls = "controls";
                                
                                var rowElm = document.createElement("tr");
                                $(rowElm).append("<td>" + episodeName + "</td>");
                                var audioTdElm = document.createElement("td");
                                $(audioTdElm).html(aElm);
                                $(rowElm).append(audioTdElm);
                                $('.episodes table').append(rowElm);
                            }
                        });
                        
                    }
            	});
            }});
            
        });
        
        </script>
            

    </head>
    
    <body>
        <div class="episodes">
            <table border="1">
                <tr><th>Name</th><th>Currently Playing</th></tr>
            </table>
        
        </div>
        
    </body>
</html>